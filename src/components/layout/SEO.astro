---
import { SITE } from "@/config/site";

type JsonLd = Record<string, any> | Record<string, any>[];

interface Props {
  title?: string;
  description?: string;
  canonical?: string;
  image?: string;
  type?: "website" | "article" | "product" | "profile" | string;
  robots?: string; // e.g., "index,follow" or "noindex,nofollow"
  keywords?: string[]; // optional, rarely used by Google
  schema?: JsonLd; // JSON-LD object or array
  publishedTime?: string; // ISO date for articles
  modifiedTime?: string;  // ISO date for articles
  locale?: string;        // e.g., "en_US"
}

const {
  title = SITE.defaultTitle,
  description = SITE.defaultDescription,
  image = SITE.defaultImage,
  type = "website",
  publishedTime,
  modifiedTime,
  locale = "en_US",
  keywords = [],
} = Astro.props;

let canonical = Astro.props.canonical;
const siteURL = new URL(SITE.url);

// If canonical not provided, build from current URL
if (!canonical && Astro.url) {
  const abs = new URL(Astro.url.pathname + Astro.url.search, SITE.url).toString();
  canonical = abs;
}

// Robots logic: allow per-page override; else decide by env
let robots = Astro.props.robots ?? "index,follow";
if (SITE.noindexEnvs?.includes(import.meta.env.MODE)) {
  robots = "noindex,nofollow";
}

// Absolute OG image
const ogImage = image?.startsWith("http")
  ? image
  : new URL(image, siteURL).toString();

// JSON-LD
const schema = Astro.props.schema;
const jsonLd = schema
  ? (Array.isArray(schema) ? schema : [schema])
  : [];
---

<!-- Primary -->
<title>{title}</title>
<meta name="description" content={description} />
<link rel="canonical" href={canonical} />
<meta name="robots" content={robots} />

<!-- (Optional) Legacy keywords â€” most search engines ignore this -->
{keywords.length > 0 && <meta name="keywords" content={keywords.join(", ")} />}

<!-- Open Graph -->
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:type" content={type} />
<meta property="og:url" content={canonical} />
<meta property="og:image" content={ogImage} />
<meta property="og:locale" content={locale} />

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={ogImage} />
{SITE.twitter && <meta name="twitter:site" content={SITE.twitter} />}

<!-- Article-specific (optional) -->
{type === "article" && publishedTime && (
  <meta property="article:published_time" content={publishedTime} />
)}
{type === "article" && modifiedTime && (
  <meta property="article:modified_time" content={modifiedTime} />
)}

<!-- JSON-LD -->
{jsonLd.length > 0 && (
  <script type="application/ld+json">
    {JSON.stringify(jsonLd)}
  </script>
)}